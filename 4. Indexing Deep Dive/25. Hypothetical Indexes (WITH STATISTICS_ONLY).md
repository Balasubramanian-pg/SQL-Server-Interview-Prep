# 25. Hypothetical Indexes (WITH STATISTICS ONLY)

Canonical documentation for 25. Hypothetical Indexes (WITH STATISTICS ONLY). This document defines concepts, terminology, and standard usage.

## Purpose
The primary purpose of hypothetical indexes is to facilitate "what-if" analysis within a database management system (DBMS). Creating physical indexes on large datasets is resource-intensive, requiring significant I/O, CPU, and storage. Hypothetical indexes allow database administrators and automated tuning tools to simulate the presence of an index to determine if the query optimizer would utilize it and how it would impact query execution plans, all without the overhead of building the actual index structure.

The "WITH STATISTICS ONLY" designation emphasizes that these objects contain only the metadata and statistical distributions (histograms, density vectors) necessary for the optimizer to estimate costs, rather than the actual data pages or B-tree structures.

> [!NOTE]
> This documentation is intended to be implementation-agnostic and authoritative.

## Scope
Clarify what is in scope and out of scope for this topic.

> [!IMPORTANT]
> **In scope:**
> * Metadata definitions of non-physical index structures.
> * The role of statistics in query cost estimation for non-existent indexes.
> * Interaction between the query optimizer and hypothetical metadata.
> * Theoretical lifecycle of a "what-if" tuning session.

> [!WARNING]
> **Out of scope:**
> * Specific vendor-specific commands (e.g., SQL Server `DBCC AUTOPILOT` or PostgreSQL `hypopg`).
> * Physical index maintenance or storage management.
> * Actual query execution (hypothetical indexes cannot be used to execute a query).

## Definitions
Provide precise definitions for key terms.

| Term | Definition |
|------|------------|
| Hypothetical Index | An index entry in the system catalog that has no associated physical data storage or B-tree structure. |
| Statistics-Only | A state where only the data distribution (histograms) is maintained to assist the optimizer, excluding the actual index keys. |
| Query Optimizer | The DBMS component that evaluates multiple execution plans and selects the most efficient one based on cost estimates. |
| Cost Estimation | The process of predicting the resource usage (I/O, CPU) of a query plan based on available statistics. |
| Metadata | Data about data; in this context, the definition of the index columns, sort order, and uniqueness constraints. |

## Core Concepts
The fundamental idea behind hypothetical indexes is the decoupling of **Index Definition** from **Index Implementation**. 

In a standard environment, an index provides two things:
1. **Statistics:** Information about data distribution used for planning.
2. **Access Path:** A physical structure used for data retrieval.

A hypothetical index provides only the first component. When a query is submitted in a "simulated" or "tuning" mode, the optimizer looks at the available hypothetical indexes. It calculates the potential selectivity and density of the columns as if they were indexed. If the optimizer determines that the hypothetical index would significantly lower the query cost, it generates a plan reflecting that hypothetical usage.

> [!TIP]
> Think of a hypothetical index as a "ghost" of a potential index. The optimizer can see the ghost and plan a route through it, but no one can actually walk on it.

## Standard Model
The standard model for utilizing hypothetical indexes follows a non-destructive lifecycle:

1.  **Identification:** A slow-running query is identified for tuning.
2.  **Definition:** A hypothetical index is defined in the system catalog. The system generates statistics for the columns involved (often by sampling the base table).
3.  **Simulation:** The query optimizer is invoked in a special mode (often called "What-If" mode) where it is instructed to consider hypothetical structures.
4.  **Evaluation:** The resulting execution plan is analyzed. If the optimizer "chooses" the hypothetical index, it indicates that a physical index would likely improve performance.
5.  **Cleanup:** The hypothetical index is dropped to prevent catalog clutter.

## Common Patterns
*   **Automated Tuning Advisors:** Many modern database engines use hypothetical indexes internally to suggest new indexes to the user.
*   **Capacity Planning:** Using hypothetical indexes to estimate how much performance gain can be achieved before committing to the storage costs of physical indexes.
*   **Regression Testing:** Simulating indexes to see if they might inadvertently cause the optimizer to choose a sub-optimal plan for other queries (plan instability).

## Anti-Patterns
*   **Production Execution Reliance:** Attempting to force a query to run using a hypothetical index. Since there is no physical data, the query will fail or revert to a table scan.
*   **Over-Creation:** Creating thousands of hypothetical indexes. While they don't consume data storage, they do consume metadata space and can slow down the optimizer by increasing the search space for plan generation.
*   **Stale Statistics:** Relying on hypothetical indexes created long ago. If the underlying table data changes significantly, the "what-if" analysis will be inaccurate.

> [!CAUTION]
> Do not confuse hypothetical indexes with "disabled" or "invisible" indexes. Disabled indexes may still occupy storage, and invisible indexes are physically maintained but ignored by the optimizer. Hypothetical indexes have no physical footprint.

## Edge Cases
*   **Skewed Data:** If the sampling rate used to generate statistics for the hypothetical index is too low, the optimizer may incorrectly estimate the index's usefulness.
*   **Complex Joins:** In multi-table joins, the optimizer's reliance on hypothetical statistics can lead to "compounding errors" in cost estimation, where the predicted benefit is vastly different from the actual benefit.
*   **Constraint Simulation:** Some systems allow hypothetical unique indexes. However, because they are hypothetical, they cannot actually enforce data integrity during `INSERT` or `UPDATE` operations.

## Related Topics
*   **Cost-Based Optimization (CBO):** The logic engine that utilizes hypothetical statistics.
*   **Index Tuning Wizards:** Tools that automate the creation and testing of hypothetical indexes.
*   **Statistics Sampling:** The methodology used to populate the "Statistics Only" portion of the index.
*   **Virtual Columns:** Often used in conjunction with hypothetical indexes to test functional indexing.

## Change Log
| Version | Date | Description |
|---------|------|-------------|
| 1.0 | 2026-02-13 | Initial AI-generated canonical documentation |