# 9. Rebuild vs Reorganize: Decision Matrix

Canonical documentation for [9. Rebuild vs Reorganize: Decision Matrix](4. Indexing Deep Dive/9. Rebuild vs Reorganize: Decision Matrix.md). This document defines concepts, terminology, and standard usage.

## Purpose
The purpose of the Rebuild vs. Reorganize decision matrix is to provide a systematic framework for maintaining data structures—specifically indexed storage—to ensure optimal query performance and storage efficiency. As data is modified, deleted, or inserted, the physical and logical order of data can diverge, leading to fragmentation. This documentation establishes the criteria for selecting the appropriate remediation strategy to balance system availability with performance gains.

> [!NOTE]
> This documentation is intended to be implementation-agnostic and authoritative, focusing on the underlying mechanics of data structure maintenance rather than specific database engine syntax.

## Scope
This documentation covers the theoretical and operational boundaries of index and data structure maintenance.

> [!IMPORTANT]
> **In scope:**
> * Logical and physical fragmentation theory.
> * Resource consumption trade-offs between maintenance types.
> * Decision-making thresholds for automated or manual intervention.
> * Impact on data density and storage I/O.

> [!WARNING]
> **Out of scope:**
> * Specific vendor implementations (e.g., T-SQL `ALTER INDEX` vs. PostgreSQL `REINDEX`).
> * Hardware-level storage optimization (e.g., SAN-level deduplication).
> * Application-level caching strategies.

## Definitions
Provide precise definitions for key terms.

| Term | Definition |
|------|------------|
| Fragmentation | The condition where data pages are out of logical sequence or contain excessive empty space. |
| Rebuild | A heavy-duty operation that drops the existing structure and recreates it from scratch, often requiring significant temporary workspace. |
| Reorganize | An in-place optimization process that physically reorders leaf-level pages and compacts data without recreating the entire structure. |
| Fill Factor | A configuration setting that determines the percentage of space on each leaf-level page to be filled with data during creation or maintenance. |
| Page Density | The ratio of actual data to the total capacity of a data page; low density indicates "internal" fragmentation. |
| Logical Fragmentation | Occurs when the logical order of pages (based on the key) does not match the physical order in the storage file. |

## Core Concepts
The fundamental challenge in data maintenance is the "Entropy of Growth." As systems evolve, the physical layout of data degrades, leading to increased I/O overhead.

**The Maintenance Trade-off**
Maintenance is a balance between **Resource Cost** (CPU, Memory, I/O, and Locking) and **Performance Debt** (the cumulative slowdown caused by fragmented data).

> [!TIP]
> Think of a library: **Reorganizing** is like a librarian walking through the aisles and pushing books closer together to close gaps. **Rebuilding** is like taking every book off the shelves, cleaning the shelves, and putting the books back in perfect alphabetical order. Reorganizing is faster and allows patrons to keep browsing, but rebuilding results in a more perfect state.

## Standard Model
The standard model for choosing between rebuilding and reorganizing is based on the percentage of fragmentation and the operational constraints of the environment.

### The Decision Matrix

| Fragmentation Level | Recommended Action | Impact on Availability | Resource Intensity |
|---------------------|--------------------|------------------------|--------------------|
| < 5%                | None               | N/A                    | None               |
| 5% - 30%            | Reorganize         | Online / Low Impact    | Low to Moderate    |
| > 30%               | Rebuild            | Offline / High Impact* | High               |

*\*Note: Some modern systems support "Online Rebuilds," but these still consume significantly more resources than a Reorganize.*

### Decision Factors
1.  **Fragmentation Percentage:** The primary metric for triggering action.
2.  **System Uptime Requirements:** Reorganizing is generally an online process, whereas rebuilding may require locks that prevent data modification.
3.  **Log Space:** Rebuilding is a logged operation that can cause significant growth in transaction or redo logs.
4.  **Available Workspace:** Rebuilding often requires temporary storage space equal to the size of the structure being rebuilt.

## Common Patterns
*   **Threshold-Based Automation:** Implementing scripts that query system metadata to calculate fragmentation and automatically execute the appropriate command based on the matrix above.
*   **Maintenance Windows:** Scheduling heavy rebuilds during periods of low system activity to mitigate the impact of resource contention.
*   **Selective Maintenance:** Prioritizing large, frequently accessed tables over small or static tables where fragmentation has negligible impact on performance.

## Anti-Patterns
*   **The "Blind Rebuild":** Rebuilding all structures on a fixed schedule regardless of actual fragmentation levels. This wastes I/O and shortens the lifespan of storage hardware.
*   **Ignoring Small Tables:** Attempting to rebuild tables that occupy only a few pages. Fragmentation in very small tables is often a false positive and does not impact performance.
*   **Over-Aggressive Fill Factors:** Setting a Fill Factor too low (e.g., 50%) in an attempt to prevent fragmentation, which results in massive storage waste and increased I/O for read operations.

> [!CAUTION]
> Avoid performing index rebuilds during peak business hours without "Online" capabilities enabled, as this can lead to severe application timeouts and blocking chains.

## Edge Cases
*   **Large Object (LOB) Data:** Reorganizing may not effectively compact pages containing LOB data (e.g., BLOBs, CLOBs). A rebuild is often required to reclaim space from LOB columns.
*   **Read-Only Data:** For data that never changes, fragmentation is a one-time cost. Once optimized via a rebuild, no further maintenance is required unless the data becomes mutable.
*   **Append-Only Tables:** Tables where data is only inserted at the end (e.g., logging tables) typically experience very low logical fragmentation but may suffer from low page density if rows are occasionally purged.

## Related Topics
*   **Statistics Maintenance:** Often performed in conjunction with rebuilds to ensure the query optimizer has accurate data distribution maps.
*   **Storage Tiering:** The physical location of data (SSD vs. HDD) influences how much fragmentation can be tolerated before performance degrades.
*   **Partitioning:** Large datasets can be partitioned, allowing for rebuilds on specific time-slices of data rather than the entire set.

## Change Log

| Version | Date | Description |
|---------|------|-------------|
| 1.0 | 2026-02-13 | Initial AI-generated canonical documentation |