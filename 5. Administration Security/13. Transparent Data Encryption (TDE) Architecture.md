# 13. Transparent Data Encryption (TDE) Architecture

Canonical documentation for [13. Transparent Data Encryption (TDE) Architecture](5. Administration Security/13. Transparent Data Encryption (TDE) Architecture.md). This document defines concepts, terminology, and standard usage.

## Purpose
Transparent Data Encryption (TDE) is designed to protect data at rest by encrypting the physical files of a database system without requiring changes to the application layer. It addresses the threat of unauthorized access to sensitive data through direct media access, such as the theft of hard drives, backup tapes, or the unauthorized copying of data files.

The primary objective of TDE is to ensure that data stored on disk is unreadable to any entity that does not possess the appropriate cryptographic keys, while remaining completely accessible to authorized database users and applications through the standard database engine interface.

> [!NOTE]
> This documentation is intended to be implementation-agnostic and authoritative, focusing on the architectural principles common to all enterprise-grade TDE systems.

## Scope
Clarify what is in scope and out of scope for this topic.

> [!IMPORTANT]
> **In scope:**
> * Cryptographic key hierarchies (DEK, KEK, Master Keys).
> * Encryption of data files, log files, and backup streams.
> * Integration with external key management systems.
> * The lifecycle of encrypted data at the storage layer.

> [!WARNING]
> **Out of scope:**
> * Encryption of data in transit (TLS/SSL).
> * Application-level encryption (Client-side encryption).
> * Specific vendor-specific syntax or configuration commands.
> * Data masking or redaction techniques.

## Definitions
| Term | Definition |
|------|------------|
| Data Encryption Key (DEK) | The symmetric key used to encrypt and decrypt the actual data blocks within the storage files. |
| Key Encryption Key (KEK) | A secondary key used to encrypt (wrap) the Data Encryption Key, providing an additional layer of security. |
| Keystore / Wallet | A secure container or service used to store and manage cryptographic keys and certificates. |
| Data at Rest | Data that is physically stored on persistent storage media (HDD, SSD, Tape, Cloud Storage). |
| Master Key | The top-level key in the hierarchy, often stored in a Hardware Security Module (HSM) or protected by the Operating System. |
| Two-Tier Hierarchy | An architecture where a Master Key protects a Data Encryption Key. |
| Entropy | The randomness collected by an operating system or hardware device for use in cryptography. |

## Core Concepts
The fundamental principle of TDE is the separation of the data access layer from the storage layer.

### Transparency
Transparency implies that the database engine handles encryption and decryption automatically during I/O operations. Applications querying the database do not need to provide keys or use specific functions to view the data. The decryption occurs in memory after the data is read from the disk.

### Key Hierarchy
TDE relies on a layered approach to key management. This prevents the actual data-encrypting keys from being stored in plain text on the same media as the data.

### The Encryption Envelope
TDE uses "envelope encryption." The Data Encryption Key (DEK) is stored within the database file header but is itself encrypted by a Key Encryption Key (KEK). This allows for efficient key rotation; one can change the KEK without re-encrypting the entire multi-terabyte database.

> [!TIP]
> Think of TDE like a locked safe (the database file). The DEK is the key inside the safe's door mechanism. The KEK is a second key that unlocks a small box containing the DEK. You can change the box's lock (KEK) easily, but the safe's internal mechanism (DEK) stays the same.

## Standard Model
The standard model for TDE architecture follows a three-step process during database operation:

1.  **Initialization:** When the database starts, it requests the Master Key/KEK from the Keystore (which may be local or remote).
2.  **Decryption of the DEK:** The database engine uses the KEK to decrypt the DEK stored in the database boot block or header.
3.  **On-the-Fly I/O:**
    *   **Write Path:** When data is moved from the buffer cache to the disk, the engine encrypts the block using the DEK.
    *   **Read Path:** When data is requested from the disk, the engine reads the encrypted block and decrypts it using the DEK before placing it in the buffer cache.

> [!IMPORTANT]
> In a standard TDE model, data in the database's memory (RAM/Buffer Cache) is typically in cleartext. TDE only protects the data once it is flushed to persistent storage.

## Common Patterns
*   **External Key Management (EKM):** Utilizing a centralized Key Management Service (KMS) or Hardware Security Module (HSM) to store the Master Key, ensuring that keys are never stored on the same server as the data.
*   **Separation of Duties:** Configuring the system so that the Database Administrator (DBA) manages the data, while a Security Officer manages the Keystore and Master Keys.
*   **Backup Encryption:** Automatically inheriting the TDE protection during the backup process, ensuring that backup files are encrypted with the same or a related key.
*   **Periodic Key Rotation:** Regularly updating the KEK/Master Key to comply with security policies and reduce the impact of a potential key compromise.

## Anti-Patterns
*   **Storing Keystores on the Same Volume as Data:** If a physical drive is stolen and it contains both the encrypted data and the keystore file, the encryption provides no protection.
*   **Using Weak Passwords for Keystores:** Protecting a high-entropy encryption key with a simple, guessable password.
*   **Assuming TDE Protects Against SQL Injection:** TDE does not protect against unauthorized access via the database application layer. If a user has "SELECT" permissions, they will see cleartext data regardless of TDE.
*   **Manual Key Management:** Hardcoding keys in scripts or configuration files rather than using a dedicated keystore.

> [!CAUTION]
> Never lose the Master Key or the Keystore password. Without the KEK, the DEK cannot be decrypted, rendering the entire database permanently inaccessible. There is no "backdoor" for recovery.

## Edge Cases
*   **Temporary Files:** Database engines often use temporary storage (TempDB, Swap) for sorting and joining. Architecture must ensure these temporary files are also encrypted to prevent data leakage.
*   **Transaction Logs:** Redo and Undo logs contain fragments of data changes. These must be encrypted using the same lifecycle as the data files.
*   **Memory Dumps:** If a database crashes, a memory dump might contain cleartext data from the buffer cache. Securing the OS-level dump location is a necessary secondary control.
*   **Initial Encryption Overhead:** The process of enabling TDE on an existing large database requires a one-time encryption of all existing blocks, which can be I/O intensive and time-consuming.

## Related Topics
*   **Key Management Interoperability Protocol (KMIP):** The standard protocol for communication between database systems and external key managers.
*   **Hardware Security Modules (HSM):** Physical devices used to safeguard and manage digital keys.
*   **Full Disk Encryption (FDE):** Encryption at the OS/Hardware level (e.g., BitLocker, LUKS), which operates at a lower layer than TDE.
*   **Homomorphic Encryption:** An advanced form of encryption allowing computation on ciphertext, which is distinct from the "decrypt-on-read" nature of TDE.

## Change Log
| Version | Date | Description |
|---------|------|-------------|
| 1.0 | 2026-02-13 | Initial AI-generated canonical documentation |