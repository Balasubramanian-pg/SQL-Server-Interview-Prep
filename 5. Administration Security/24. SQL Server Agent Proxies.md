# 24. SQL Server Agent Proxies

Canonical documentation for [24. SQL Server Agent Proxies](5. Administration Security/24. SQL Server Agent Proxies.md). This document defines concepts, terminology, and standard usage.

## Purpose
The primary purpose of SQL Server Agent Proxies is to enforce the Principle of Least Privilege (PoLP) within an automated task environment. By default, SQL Server Agent job steps execute under the security context of the SQL Server Agent Service Account. This often leads to "over-privileged" service accounts that possess broad administrative rights across the operating system and network.

Proxies provide a secure mechanism to delegate specific tasks to specialized security principals. This allows administrators to grant a job step only the specific permissions required for its execution (e.g., accessing a specific file share or executing a script) without elevating the permissions of the entire SQL Server Agent service.

> [!NOTE]
> This documentation is intended to be implementation-agnostic and authoritative regarding the architectural role of proxies within the SQL Server ecosystem.

## Scope
Clarify what is in scope and out of scope for this topic.

> [!IMPORTANT]
> **In scope:**
> * The relationship between Credentials, Proxies, and Subsystems.
> * Security context switching and impersonation logic.
> * Authorization models for proxy usage by non-administrative users.
> * Theoretical boundaries of job step isolation.

> [!WARNING]
> **Out of scope:**
> * Specific Windows Operating System security hardening (e.g., GPO settings).
> * Third-party job scheduling alternatives.
> * Step-by-step GUI tutorials for specific SQL Server versions.

## Definitions
Provide precise definitions for key terms.

| Term | Definition |
|------|------------|
| Credential | A record containing the authentication information (identity and secret) required to connect to a resource outside of the database engine. |
| Proxy Account | An object that associates a Credential with one or more SQL Server Agent subsystems, allowing job steps to run under that credential's identity. |
| Subsystem | A predefined execution environment within the Agent (e.g., PowerShell, SSIS, CmdExec) that defines how a job step is processed. |
| Principal | A database user or role that is granted permission to utilize a specific Proxy Account. |
| Impersonation | The process by which the SQL Server Agent switches its security context to that of the Proxy's credential for the duration of a job step. |

## Core Concepts
The Proxy architecture relies on a three-tier mapping system: **Identity -> Proxy -> Subsystem**.

1.  **Identity Mapping:** A Credential stores the OS-level username and password.
2.  **Functional Mapping:** The Proxy links that Credential to specific Subsystems. For example, a "DataTransferProxy" might be restricted only to the SQL Server Integration Services (SSIS) subsystem.
3.  **Access Control:** The Proxy defines which SQL Server logins or roles are permitted to use it.

> [!TIP]
> Think of a Proxy as a "Security Gateway." The Credential is the key, the Subsystem is the specific room the key opens, and the Principal is the person authorized to hold that key.

## Standard Model
The standard model for implementing Proxies follows a structured hierarchy to ensure security and maintainability:

1.  **Credential Creation:** Define an OS-level service account with the minimum necessary permissions for the target task.
2.  **Proxy Definition:** Create the Proxy object and link it to the Credential.
3.  **Subsystem Association:** Limit the Proxy to only the subsystems required (e.g., only `CmdExec` for batch files).
4.  **Principal Assignment:** Grant specific database users (who are not `sysadmins`) the right to use the Proxy.
5.  **Job Step Configuration:** Configure the SQL Server Agent job step to "Run as" the defined Proxy.

## Common Patterns
*   **The SSIS Executor:** A proxy dedicated to running Integration Services packages, granted read/write access only to specific data staging areas and network shares.
*   **The Scripting Sandbox:** A proxy for PowerShell or CmdExec steps that has no network access and is restricted to a local "scratch" directory.
*   **The Maintenance Operator:** A proxy used by junior DBAs to run specific maintenance tasks without granting them `sysadmin` rights on the instance.

## Anti-Patterns
*   **The "God" Proxy:** Creating a single proxy linked to a high-privilege account (like a Domain Admin) and using it for all job steps.
*   **Credential Reuse:** Using the same OS account for the SQL Server Engine service, the SQL Server Agent service, and the Proxy account.
*   **Over-Broad Subsystem Assignment:** Enabling all subsystems for a proxy when only one is needed, increasing the attack surface for command injection or privilege escalation.

> [!CAUTION]
> Granting `sysadmin` members access to proxies is redundant but harmless; however, granting non-privileged users access to a proxy that uses a high-privilege OS account can lead to a complete system compromise.

## Edge Cases
*   **Password Expiration:** If the OS-level password for a Credential expires or is changed, all associated Proxies will fail silently until the Credential object is manually updated within the database engine.
*   **Domain Controller Availability:** Proxies using domain accounts require a functional connection to the Active Directory. If the SQL Server instance loses connectivity to the DC, proxy-based job steps will fail to authenticate.
*   **Interactive Login Rights:** Some subsystems may require the "Allow log on locally" or "Log on as a batch job" rights within the Windows Security Policy. Failure to grant these at the OS level will prevent the Proxy from initializing.
*   **Double-Hop Issues:** Proxies executing tasks that require further authentication to a third server (e.g., a proxy running a script that accesses a remote SQL Server) may encounter Kerberos delegation issues.

## Related Topics
*   **SQL Server Agent Subsystems:** The specific execution engines that utilize proxies.
*   **Database Engine Credentials:** The underlying storage mechanism for proxy identities.
*   **Role-Based Access Control (RBAC):** The broader security framework governing who can manage and use proxies.
*   **Principle of Least Privilege (PoLP):** The security philosophy driving the use of proxies.

## Change Log
| Version | Date | Description |
|---------|------|-------------|
| 1.0 | 2026-02-13 | Initial AI-generated canonical documentation |