# 12. Always Encrypted with Enclaves

Canonical documentation for [12. Always Encrypted with Enclaves](5. Administration Security/12. Always Encrypted with Enclaves.md). This document defines concepts, terminology, and standard usage.

## Purpose
The purpose of Always Encrypted with Enclaves is to extend the capabilities of client-side encryption by allowing a database system to perform rich computations on sensitive data without ever exposing that data in plaintext to the database engine, the operating system, or the hosting environment's administrators.

This technology addresses the fundamental tension between data privacy and data utility. While standard client-side encryption protects data at rest and in transit, it typically limits the database to simple equality comparisons. Enclaves introduce a Trusted Execution Environment (TEE) that allows for complex operations—such as pattern matching, range comparisons, and sorting—while maintaining a zero-trust posture regarding the server-side infrastructure.

> [!NOTE]
> This documentation is intended to be implementation-agnostic and authoritative, focusing on the architectural pattern of secure enclave-based data processing.

## Scope
This documentation covers the theoretical framework, architectural requirements, and operational logic of enclave-augmented encryption.

> [!IMPORTANT]
> **In scope:**
> * Secure enclave architecture and Trusted Execution Environments (TEEs).
> * Attestation mechanisms and trust verification.
> * Cryptographic boundaries between the client, the database engine, and the enclave.
> * Functional capabilities enabled by enclave-based processing (e.g., rich queries, in-place encryption).

> [!WARNING]
> **Out of scope:**
> * Specific hardware vendor implementation details (e.g., specific CPU instruction sets).
> * Step-by-step configuration guides for specific cloud service providers.
> * Performance benchmarking for specific database versions.

## Definitions
| Term | Definition |
|------|------------|
| Trusted Execution Environment (TEE) | A secure, isolated area of a processor that guarantees code and data loaded inside are protected with respect to confidentiality and integrity. |
| Secure Enclave | A specific instance of a TEE used by the database engine to process sensitive data in plaintext within a protected memory space. |
| Attestation | The process by which a client verifies that the enclave is genuine, correctly configured, and running the expected authorized code before releasing sensitive keys. |
| In-place Encryption | The ability to perform cryptographic transformations (encrypting, decrypting, or re-encrypting data) directly on the server within the enclave, avoiding data egress. |
| Rich Computation | Operations beyond simple equality, such as range searches (`>`, `<`), pattern matching (`LIKE`), and sorting (`ORDER BY`). |
| Attestation Service | An external, trusted entity that validates the enclave's identity and health, providing a token to the client. |

## Core Concepts
The fundamental idea behind Always Encrypted with Enclaves is the creation of a "secure island" within an untrusted host.

### The Cryptographic Boundary
In standard encryption models, the database engine is outside the cryptographic boundary. With enclaves, the boundary is extended to include a specific, isolated portion of the server's CPU and memory. However, the database engine *itself* remains outside this boundary; it can only see the enclave as a "black box."

### Attestation and Trust
Trust is not assumed; it is proven. Before a client application sends a decryption key to the server, it demands an attestation report. This report proves that the enclave is a legitimate TEE and that the code running inside it has not been tampered with.

> [!TIP]
> Think of the enclave as a high-security clean room inside a public warehouse. The warehouse staff (the Database Engine/OS) can move boxes (encrypted data) to the door of the clean room, but they cannot see inside or enter. Only authorized personnel (the Client) can provide the key to the clean room to process the contents.

## Standard Model
The standard model for Always Encrypted with Enclaves follows a specific lifecycle for query execution:

1.  **Query Submission:** The client driver identifies that a query requires enclave processing (e.g., a `LIKE` operation on an encrypted column).
2.  **Attestation:** The client performs attestation with the server's enclave, often involving a third-party Attestation Service to verify the enclave's integrity.
3.  **Key Release:** Once trust is established, the client securely transmits the Column Encryption Key (CEK) to the enclave over a secure channel (e.g., Diffie-Hellman).
4.  **Data Processing:** The database engine sends the encrypted data to the enclave. The enclave decrypts the data in its isolated memory, performs the requested operation, and returns only the encrypted result or a boolean status to the engine.
5.  **Result Return:** The engine completes the query execution and returns the encrypted results to the client.

## Common Patterns
*   **In-place Schema Evolution:** Using the enclave to encrypt existing plaintext columns or rotate keys without moving data out of the database.
*   **Confidential Search:** Enabling wildcard searches and range queries on sensitive fields like National ID numbers or financial amounts.
*   **Secure Indexing:** Creating indexes on encrypted columns where the enclave assists in maintaining the index structure without exposing plaintext to the B-Tree logic.

## Anti-Patterns
*   **Bypassing Attestation:** Disabling or "mocking" attestation in production environments, which eliminates the security guarantees of the enclave.
*   **Over-Encryption:** Encrypting non-sensitive data that requires heavy computation, leading to unnecessary performance overhead.
*   **Collation Mismatches:** Using different collations between the client and the enclave, which can lead to incorrect sorting or filtering results.

> [!CAUTION]
> Do not store the Column Master Key (CMK) on the database server. The enclave model relies on the CMK remaining in a trusted key store (e.g., a Hardware Security Module or a Key Vault) accessible only to the client.

## Edge Cases
*   **Enclave Memory Exhaustion:** TEEs often have limited protected memory (EPC). Large joins or complex aggregations on encrypted data may exceed this limit, leading to performance degradation or query failure.
*   **Cold Starts:** The first query requiring an enclave may incur latency due to the overhead of enclave initialization and the attestation handshake.
*   **Hardware Migrations:** Moving a database to a server without TEE support (or with a different TEE version) will render enclave-protected data inaccessible for rich queries.
*   **Non-Deterministic Encryption:** While enclaves support randomized encryption (which is more secure), users must ensure the enclave is properly configured to handle the specific cryptographic algorithms used.

## Related Topics
*   **Client-Side Encryption:** The foundational technology upon which enclaves are built.
*   **Trusted Execution Environments (TEE):** The hardware-level isolation technology.
*   **Key Management Systems (KMS):** Systems used to store the Master Keys that authorize enclave access.
*   **Homomorphic Encryption:** An alternative (mathematical) approach to computing on encrypted data without enclaves.

## Change Log
| Version | Date | Description |
|---------|------|-------------|
| 1.0 | 2026-02-13 | Initial AI-generated canonical documentation |