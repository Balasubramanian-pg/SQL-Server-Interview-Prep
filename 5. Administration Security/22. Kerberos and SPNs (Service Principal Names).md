# 22. Kerberos and SPNs (Service Principal Names)

Canonical documentation for [22. Kerberos and SPNs (Service Principal Names)](5. Administration Security/22. Kerberos and SPNs (Service Principal Names).md). This document defines concepts, terminology, and standard usage.

## Purpose
The Kerberos protocol and Service Principal Names (SPNs) exist to provide a secure, ticket-based mutual authentication framework within distributed networks. The primary problem space addressed is the need for a client to prove its identity to a service—and for the service to prove its identity to the client—without transmitting passwords over the network and without requiring the service to maintain a database of user credentials.

SPNs serve as the unique identifiers that bridge the gap between a network service and the security principal (account) under which that service executes. They allow the authentication infrastructure to locate the correct account to encrypt a session ticket.

> [!NOTE]
> This documentation is intended to be implementation-agnostic and authoritative, focusing on the underlying logic of the Kerberos v5 protocol and the structural requirements of SPNs.

## Scope
Clarify what is in scope and out of scope for this topic.

> [!IMPORTANT]
> **In scope:**
> * The theoretical mechanics of the Kerberos authentication flow.
> * The syntax and structural requirements of Service Principal Names.
> * The relationship between Principals, Keys, and the Key Distribution Center (KDC).
> * The role of SPNs in service discovery and ticket encryption.

> [!WARNING]
> **Out of scope:**
> * Specific vendor implementations (e.g., Microsoft Active Directory, MIT Kerberos, Heimdal) except where used to illustrate universal standards.
> * Step-by-step configuration guides for specific operating systems.
> * Programming language-specific library documentation (e.g., GSSAPI, SSPI).

## Definitions
Provide precise definitions for key terms.

| Term | Definition |
|------|------------|
| Principal | A unique identity in a Kerberos system to which the KDC can assign tickets (can be a user, computer, or service). |
| Service Principal Name (SPN) | A unique alias used by a client to identify an instance of a service for the purpose of mutual authentication. |
| Key Distribution Center (KDC) | A trusted third party that mediates authentication; consists of the Authentication Service (AS) and the Ticket Granting Service (TGS). |
| Ticket Granting Ticket (TGT) | A credential issued by the AS that proves the principal's identity to the TGS. |
| Service Ticket (ST) | A credential issued by the TGS that allows a client to access a specific service identified by an SPN. |
| Realm | A logical authentication boundary or domain within which a KDC has authority. |
| Keytab | A file containing pairs of Kerberos principals and encrypted keys, allowing a service to authenticate without manual password entry. |

## Core Concepts
The Kerberos protocol is built on the foundation of symmetric-key cryptography and a trusted third party (the KDC).

### The Identity-Service Link
For a service to participate in Kerberos authentication, it must be associated with a security principal. The SPN is the "lookup key" used by the KDC to find the account that holds the service's long-term secret key. Without a correctly registered SPN, the KDC cannot determine which key to use to encrypt the Service Ticket, and authentication will fail.

### Mutual Authentication
Unlike simple password-based systems, Kerberos allows the client to verify that the server is who it claims to be. Because the Service Ticket is encrypted with the service's secret key, only the legitimate service can decrypt it and respond with a valid authenticator.

> [!TIP]
> Think of an SPN as a "Business Name" and the Principal as the "Legal Entity." A client looks for the "Business Name" (SPN) to start a transaction, but the KDC ensures the "Legal Entity" (Principal) is the one actually signing the contract.

## Standard Model
The standard Kerberos authentication model follows a multi-step exchange often referred to as the "Three-Headed Dog" (Client, Server, and KDC).

1.  **Authentication Service (AS) Exchange:** The client requests a TGT from the KDC by proving knowledge of its own password (or key).
2.  **Ticket Granting Service (TGS) Exchange:** The client presents the TGT to the KDC and requests a Service Ticket for a specific **SPN** (e.g., `HTTP/webserver.example.com`).
3.  **Application (AP) Exchange:** The client presents the Service Ticket to the target server. The server decrypts the ticket using its own secret key to verify the client's identity.

### SPN Composition
A standard SPN follows the format: `<service class>/<host>:<port>/<service name>`
*   **Service Class:** The type of service (e.g., `www`, `nfs`, `host`, `mssql`).
*   **Host:** The Fully Qualified Domain Name (FQDN) of the server.
*   **Port:** (Optional) The port number if the service runs on a non-standard port.
*   **Service Name:** (Optional) Used for complex services or instances.

## Common Patterns
*   **Host-based SPNs:** The most common pattern where a service is tied to the identity of the machine it runs on (e.g., `host/server01.internal`).
*   **Service Account SPNs:** Used when a service runs under a dedicated service account rather than the machine account. This is critical for load-balanced clusters where multiple servers provide the same service.
*   **Delegation:** A pattern where a service (e.g., a web server) is authorized to impersonate a client to access a backend service (e.g., a database) using the client's identity.

## Anti-Patterns
*   **Duplicate SPNs:** Registering the same SPN on two different accounts. This creates ambiguity for the KDC, leading to unpredictable authentication failures.
*   **Using IP Addresses in SPNs:** Kerberos is designed for FQDNs. Using IP addresses often breaks the lookup mechanism and prevents successful ticket requests.
*   **Over-privileged Service Accounts:** Running services under administrative accounts rather than least-privilege accounts with specific SPNs.
*   **Short Ticket Lifetimes without Renewal:** Setting ticket expirations shorter than the duration of long-running batch processes without implementing renewal logic.

> [!CAUTION]
> Never register an SPN for a user account unless that account is strictly used as a service identity. Doing so can expose the account to Kerberoasting attacks, where attackers request tickets to attempt offline brute-force decryption.

## Edge Cases
*   **Clock Skew:** Kerberos relies heavily on timestamps to prevent replay attacks. If the clocks of the Client, KDC, and Server differ by more than a defined threshold (usually 5 minutes), authentication will fail.
*   **Cross-Realm Authentication:** When a client in Realm A needs to access a service in Realm B. This requires a trust relationship between KDCs and specific routing of SPN requests.
*   **CNAME vs. A-Record:** Many Kerberos implementations require the SPN to match the A-record (canonical name) of the server. If a client uses a CNAME to access a service, the SPN lookup might fail if the client does not resolve the CNAME to the target A-record first.
*   **Case Sensitivity:** While the Kerberos protocol itself is case-sensitive regarding principals, many directory services (like Active Directory) treat SPNs as case-insensitive. This can lead to "hidden" duplicates if not managed carefully.

## Related Topics
*   **Keytabs:** The mechanism for storing SPN keys on non-interactive systems.
*   **GSSAPI (Generic Security Services Application Program Interface):** The standard API used by applications to interact with Kerberos.
*   **PAC (Privilege Attribute Certificate):** An extension that carries authorization data (like group memberships) inside the Kerberos ticket.
*   **Kerberoasting:** A security exploit targeting the encryption of service tickets associated with SPNs.

## Change Log
| Version | Date | Description |
|---------|------|-------------|
| 1.0 | 2026-02-13 | Initial AI-generated canonical documentation |