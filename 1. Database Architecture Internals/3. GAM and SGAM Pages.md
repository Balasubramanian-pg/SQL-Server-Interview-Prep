# 3. GAM and SGAM Pages

Canonical documentation for [3. GAM and SGAM Pages](1. Database Architecture Internals/3. GAM and SGAM Pages.md). This document defines concepts, terminology, and standard usage.

## Purpose
The purpose of Global Allocation Map (GAM) and Shared Global Allocation Map (SGAM) pages is to provide a high-performance, bitmapped mechanism for tracking space allocation within a database storage engine. These structures allow the system to quickly identify available extents for data storage without scanning the entire physical file.

By using a bitmapped approach, the storage engine can manage millions of pages with minimal memory and I/O overhead, ensuring that allocation requests remain efficient even as data volumes scale.

> [!NOTE]
> This documentation is intended to be implementation-agnostic and authoritative, focusing on the architectural logic of extent-based allocation maps.

## Scope
Clarify what is in scope and out of scope for this topic.

> [!IMPORTANT]
> **In scope:**
> * The logical structure and bit-mapping of GAM and SGAM pages.
> * The relationship between extents and allocation maps.
> * The decision matrix for selecting extents based on map states.
> * Interval-based management of large data files.

> [!WARNING]
> **Out of scope:**
> * Specific vendor-specific file headers (e.g., MDF/NDF specific headers).
> * Page Free Space (PFS) byte-level tracking (which tracks individual page density).
> * Hardware-level block management or RAID controller logic.

## Definitions
Provide precise definitions for key terms.

| Term | Definition |
|------|------------|
| Page | The fundamental unit of data storage, typically 8 KB in size. |
| Extent | A collection of eight contiguous pages, used as the basic unit of space management. |
| GAM | Global Allocation Map; a bitmap tracking whether an extent is allocated or free. |
| SGAM | Shared Global Allocation Map; a bitmap tracking whether an extent is currently used as a mixed extent and has at least one free page. |
| Uniform Extent | An extent owned by a single object; all eight pages are dedicated to that object. |
| Mixed Extent | An extent shared by multiple objects; each of the eight pages can be owned by a different entity. |
| Bitmapped Tracking | A method where a single bit represents the state of a larger resource (in this case, an extent). |

## Core Concepts
The fundamental idea behind GAM and SGAM pages is the reduction of metadata overhead. Instead of maintaining complex linked lists or trees of free space, the system uses a dense bit array.

### The Allocation Interval
Allocation maps do not cover the entire database in a single page. Instead, they occur at fixed intervals. A single GAM or SGAM page typically covers a specific number of extents (often ~64,000 extents, representing roughly 4 GB of data). When a file grows beyond this interval, a new GAM and SGAM page are initialized.

### Bit State Logic
*   **GAM Pages:** Track extent usage.
    *   `1`: The extent is free (available for allocation).
    *   `0`: The extent is allocated (used as a uniform or mixed extent).
*   **SGAM Pages:** Track mixed extent availability.
    *   `1`: The extent is a mixed extent and has at least one free page.
    *   `0`: The extent is either not a mixed extent, or it is a mixed extent with all eight pages currently in use.

> [!TIP]
> Think of the GAM as a "Master Occupancy" sign for a building (is the room empty or taken?) and the SGAM as a "Roommate Wanted" sign (is there a bed available in a shared room?).

## Standard Model
The standard model for space allocation follows a specific hierarchy when a request for new space is made:

1.  **Request for Uniform Extent:** The engine searches the GAM for the first bit set to `1`. It changes that bit to `0` and assigns the extent to the object.
2.  **Request for Mixed Page:** The engine searches the SGAM for the first bit set to `1`. If found, it allocates a page within that mixed extent.
3.  **Exhaustion of Mixed Space:** If no bits are set to `1` in the SGAM, the engine searches the GAM for a free extent (bit `1`), allocates it, marks it as a mixed extent in the SGAM, and then allocates the page.

## Common Patterns
*   **Proportional Fill:** In systems with multiple files, the engine uses GAM/SGAM data to distribute allocations across files based on the relative free space in each.
*   **Allocation Caching:** To prevent constant I/O to the allocation pages, the engine often caches the location of the last searched "free" bit to start the next search from that point (Next-Fit algorithm).

## Anti-Patterns
*   **Single-File Bottlenecks:** Relying on a single data file for a high-concurrency write workload can lead to "latch contention" on the GAM and SGAM pages, as multiple threads attempt to update the same bitmap simultaneously.
*   **Frequent Small Growths:** Configuring a database to grow in very small increments causes frequent initialization of new GAM/SGAM intervals, leading to physical fragmentation and metadata overhead.

> [!CAUTION]
> Avoid configurations that lead to "Allocation Map Contention." This occurs when too many concurrent sessions attempt to modify the same GAM/SGAM page, resulting in significant wait times (often seen as `PAGELATCH_UP` or similar wait types).

## Edge Cases
*   **File Shrinkage:** When a file is shrunk, the engine must move data from the end of the file to the beginning. This requires a massive update to GAM and SGAM bits and can lead to significant fragmentation of the allocation maps themselves.
*   **Corrupted Bitmaps:** If a GAM bit indicates an extent is free but the extent actually contains data, the system may overwrite existing data. Conversely, if a bit indicates an extent is allocated but it is actually empty, that space becomes "lost" to the system until a consistency check or rebuild occurs.
*   **Large Page Allocations:** Systems using "Large Pages" or "Huge Pages" at the OS level may bypass standard extent-based GAM logic depending on the specific storage engine implementation.

## Related Topics
*   **PFS (Page Free Space):** Tracks byte-level free space within individual pages.
*   **IAM (Index Allocation Map):** Tracks which extents belong to a specific table or index.
*   **Extent Management:** The broader strategy of grouping pages for I/O efficiency.
*   **Transaction Logging:** How changes to GAM/SGAM pages are recorded to ensure atomicity.

## Change Log
| Version | Date | Description |
|---------|------|-------------|
| 1.0 | 2026-02-11 | Initial AI-generated canonical documentation |