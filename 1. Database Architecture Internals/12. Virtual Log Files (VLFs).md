# 12. Virtual Log Files (VLFs)

Canonical documentation for [12. Virtual Log Files (VLFs)](1. Database Architecture Internals/12. Virtual Log Files (VLFs).md). This document defines concepts, terminology, and standard usage.

## Purpose
Virtual Log Files (VLFs) serve as the fundamental unit of physical organization within a write-ahead transaction log. While a transaction log is presented to the database engine as a logical, continuous stream of records, the underlying storage system requires a mechanism to manage space allocation, reuse, and truncation. 

The VLF structure exists to solve the problem of "infinite" sequential logging on finite physical media. By dividing a single physical log file into multiple virtual segments, the system can track which portions of the log are no longer needed for recovery and mark them for reuse without shifting data or reallocating the entire file.

> [!NOTE]
> This documentation is intended to be implementation-agnostic and authoritative, focusing on the architectural necessity of log segmentation.

## Scope
Clarify what is in scope and out of scope for this topic.

> [!IMPORTANT]
> **In scope:**
> * The internal segmentation of sequential log files.
> * The lifecycle of a VLF (Active, Recoverable, Reusable).
> * The relationship between physical file growth and VLF creation.
> * Impact of VLF density on system recovery and performance.

> [!WARNING]
> **Out of scope:**
> * Specific vendor-specific algorithms for VLF creation (e.g., exact formulas used by different SQL engine versions).
> * Hardware-level disk sectoring or file system block management.
> * Application-level transaction logic.

## Definitions
Provide precise definitions for key terms.

| Term | Definition |
|------|------------|
| VLF (Virtual Log File) | A contiguous segment of a physical transaction log file used to manage log truncation and reuse. |
| Log Truncation | The process of marking inactive VLFs as reusable because the transactions within them have been hardened or backed up. |
| Active VLF | A segment containing log records required for a full recovery, including the oldest uncommitted transaction. |
| Log Sequence Number (LSN) | A unique identifier assigned to every record in the log, used to maintain chronological order across VLFs. |
| Log Fragmentation | A state where a physical log file is composed of an excessive number of small VLFs, leading to performance degradation. |
| Circular Logging | The process where the system wraps around to the beginning of the physical file to reuse truncated VLFs. |

## Core Concepts
The transaction log is logically a serial string of log records. Physically, it is one or more files. VLFs are the "containers" within those files.

### The Circular Nature of Logging
The database engine writes to VLFs sequentially. When the end of the last VLF in a physical file is reached, the engine "wraps around" to the first VLF, provided that the first VLF has been truncated (is no longer active).

### VLF States
1.  **Active:** Contains the "active" portion of the log. This includes records needed for undo/redo operations during recovery or records not yet backed up.
2.  **Recoverable (Inactive):** Contains records that are no longer needed for the current engine operation but may be needed for log backups or replication.
3.  **Reusable:** The segment has been truncated and is available for new log records.

> [!TIP]
> Think of VLFs like the pages in a notebook. You write on them in order. Once a page is completely filled and the information on it is archived elsewhere, you can erase that page and use it again. If you have too many tiny pages, you spend more time turning pages than writing.

## Standard Model
In a standard implementation, the number and size of VLFs are determined at the time of file creation or during a growth event. 

1.  **Creation/Growth:** When a log file is created or expanded, the engine divides the new space into a specific number of VLFs based on the size of the increment.
2.  **Sequential Usage:** The engine fills one VLF entirely before moving to the next.
3.  **Truncation Unit:** Truncation occurs at the VLF level, not the individual record level. An entire VLF must be free of active transactions before it can be marked as reusable.
4.  **Recovery:** During system startup, the engine must scan the VLFs to find the "head" and "tail" of the log to perform recovery.

## Common Patterns
*   **Proactive Sizing:** Initializing the transaction log to its expected peak size to ensure a manageable number of VLFs are created upfront.
*   **Controlled Growth:** Using large, fixed growth increments (e.g., 1GB or 8GB) rather than small percentages to prevent the creation of thousands of tiny VLFs.
*   **Periodic Monitoring:** Auditing the VLF count to ensure it remains within optimal bounds (typically in the hundreds, rather than thousands).

## Anti-Patterns
*   **Small Auto-growth Increments:** Setting the log to grow by 1MB or 10% on a large system. This results in "Log Fragmentation," where a single file may contain tens of thousands of VLFs.
*   **Frequent Shrinking:** Repeatedly shrinking the log file and letting it grow back. This forces the engine to constantly recreate VLF structures and often leads to high fragmentation.
*   **Neglecting Backups:** In certain recovery models, failing to perform log backups prevents VLFs from being truncated, leading to file exhaustion even if the VLFs are not "active" in the traditional sense.

> [!CAUTION]
> Excessive VLF counts (fragmentation) can significantly increase the time required for database recovery, backups, and replication, as the engine must metadata-manage each segment individually.

## Edge Cases
*   **The "Giant" VLF:** If a log file is grown by an enormous amount in a single event, the resulting VLFs may be too large. Since truncation only happens at the VLF boundary, a single long-running transaction in a giant VLF can prevent the reuse of a massive amount of disk space.
*   **Log Wrap-Around Failure:** If the engine reaches the end of the physical file and the first VLF is still "Active," the log cannot wrap around. This results in a "Log Full" error, even if there is physical disk space available, because the file cannot grow or reuse existing segments.
*   **Zero-Length VLFs:** In rare corruption scenarios or interrupted growth events, a VLF header might exist without usable space, requiring manual intervention or file recreation.

## Related Topics
*   **Write-Ahead Logging (WAL):** The protocol that necessitates the existence of VLFs.
*   **Log Sequence Numbers (LSNs):** The addressing system used to navigate VLFs.
*   **Recovery Models:** Policies that determine when a VLF can transition from Recoverable to Reusable.
*   **Checkpoints:** The mechanism that flushes dirty pages to disk, often a prerequisite for VLF truncation.

## Change Log
| Version | Date | Description |
|---------|------|-------------|
| 1.0 | 2026-02-11 | Initial AI-generated canonical documentation |