# 25. PFS Contention in TempDB

Canonical documentation for [25. PFS Contention in TempDB](1. Database Architecture Internals/25. PFS Contention in TempDB.md). This document defines concepts, terminology, and standard usage.

## Purpose
The purpose of this topic is to address a specific performance bottleneck occurring within the temporary storage subsystem of a relational database management system (RDBMS). PFS (Page Free Space) contention arises when high-concurrency workloads attempt to allocate or deallocate space simultaneously, leading to serialized access to the metadata pages that track page availability.

This documentation describes the mechanics of this contention, the architectural reasons for its existence, and the theoretical framework for mitigating its impact on system throughput.

> [!NOTE]
> This documentation is intended to be implementation-agnostic and authoritative, focusing on the underlying data structures and concurrency models common to page-based storage engines.

## Scope
Clarify what is in scope and out of scope for this topic.

> [!IMPORTANT]
> **In scope:**
> * Mechanics of Page Free Space (PFS) tracking.
> * Latch contention types associated with allocation metadata.
> * The relationship between concurrent object creation/destruction and metadata bottlenecks.
> * Architectural strategies for distributing allocation overhead.

> [!WARNING]
> **Out of scope:**
> * Specific hardware-level storage latency issues (IOPS/Throughput).
> * General SQL tuning unrelated to temporary object lifecycle.
> * Specific vendor-specific syntax for configuration, though the underlying principles apply.

## Definitions
Provide precise definitions for key terms.

| Term | Definition |
|------|------------|
| PFS Page | A specialized metadata page that tracks the allocation status and the amount of free space available on individual data pages. |
| Latch | A lightweight, short-term synchronization object used to protect pages in memory from conflicting access by multiple threads. |
| PAGELATCH | A specific wait type occurring when a thread requests access to a page in the buffer pool that is currently held by another thread. |
| Extent | A collection of eight physically contiguous pages, used as the basic unit of space management. |
| Proportional Fill | An algorithm that distributes data across multiple files based on the free space available in each file. |
| Metadata Contention | A state where the management of data structures (like PFS, GAM, or SGAM) becomes the primary bottleneck rather than the data itself. |

## Core Concepts
The fundamental challenge of PFS contention lies in the serialization of page-level metadata updates.

In a page-based storage engine, the system must know which pages are empty and which have enough space to accommodate new rows. This is tracked via PFS pages. Each PFS page covers a fixed interval of data pages (typically ~8,000 pages).

When a process creates a temporary table or inserts data into one, the engine must:
1.  Consult the PFS page to find a page with available space.
2.  Modify the PFS page to reflect the new space usage.
3.  Release the latch on the PFS page.

In high-concurrency environments, hundreds of threads may attempt to perform these steps simultaneously. Because only one thread can modify a PFS page at a time (Update or Exclusive latch), the remaining threads must wait, leading to a "convoy effect."

> [!TIP]
> Think of a PFS page as a single sign-in sheet for a large office building. Even if the building has thousands of empty desks, if every person entering the building must wait in a single line to sign the same sheet, the entry rate is limited by the speed of the pen, not the capacity of the building.

## Standard Model
The standard model for resolving PFS contention involves horizontal partitioning of the metadata.

1.  **File Multiplicity:** Instead of a single data file for the temporary database, the system utilizes multiple data files of identical size.
2.  **Round-Robin Allocation:** The storage engine distributes allocation requests across these files. Since each file possesses its own set of PFS pages, increasing the number of files increases the number of "sign-in sheets" available.
3.  **Uniform Extent Allocation:** By ensuring that all allocations are made in full extents (8 pages at a time) rather than single pages, the frequency of PFS updates is reduced.

## Common Patterns
*   **The Power of Two/Eight:** A common pattern is to align the number of temporary data files with the number of logical processors, often capping at eight files to balance metadata overhead against contention relief.
*   **Equal Sizing:** Ensuring all temporary data files are exactly the same size to ensure the proportional fill algorithm distributes load evenly.
*   **Monitoring Wait Statistics:** Identifying `PAGELATCH_UP` (Update) or `PAGELATCH_EX` (Exclusive) waits specifically on the first few pages of a file (e.g., Page 1, Page 8088).

## Anti-Patterns
*   **Single File Configuration:** Relying on a single data file for a high-core-count server.
*   **Auto-growth Disparity:** Allowing files to grow at different rates or to different sizes, which causes the proportional fill algorithm to favor one file, re-concentrating the contention.
*   **Excessive Object Churn:** Designing applications that create and drop thousands of small temporary tables per second rather than reusing objects or using memory-resident structures.

> [!CAUTION]
> Avoid adding an excessive number of data files (e.g., hundreds) without evidence of contention. Over-provisioning files can increase the overhead of switching between files and complicate management without providing marginal performance gains.

## Edge Cases
*   **Instant File Initialization (IFI):** While IFI speeds up file growth, it does not directly solve PFS contention; however, the lack of IFI can exacerbate the perceived duration of contention during growth events.
*   **Metadata Contention vs. PFS Contention:** Sometimes the bottleneck is not the PFS page (space tracking) but the system catalog tables (object tracking). This is a different form of contention requiring different mitigation (e.g., memory-optimized metadata).
*   **Large Object (LOB) Storage:** Temporary tables containing LOB data types may interact with PFS pages differently due to how out-of-row data is allocated, potentially shifting the contention point.

## Related Topics
*   **GAM and SGAM Contention:** Similar allocation bottlenecks involving Global Allocation Maps.
*   **Latch Concurrency:** The broader study of internal database synchronization.
*   **TempDB Optimization:** The holistic approach to tuning temporary storage.
*   **Proportional Fill Algorithms:** The logic used to balance I/O across multiple files.

## Change Log
| Version | Date | Description |
|---------|------|-------------|
| 1.0 | 2026-02-11 | Initial AI-generated canonical documentation |