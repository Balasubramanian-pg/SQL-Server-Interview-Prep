# 47. Filestream Storage

Canonical documentation for [47. Filestream Storage](1. Database Architecture Internals/47. Filestream Storage.md). This document defines concepts, terminology, and standard usage.

## Purpose
Filestream Storage addresses the architectural challenge of managing large binary objects (BLOBs) within a data management system. Traditionally, architects faced a binary choice: store data directly in the database (ensuring transactional integrity but sacrificing performance and scalability) or store data in a filesystem (ensuring performance but sacrificing data consistency and security).

Filestream Storage exists to bridge this gap by integrating the database engine with a high-performance filesystem. It allows large binary data to be stored on the physical disk as independent files while remaining under the transactional control and security umbrella of the database management system.

> [!NOTE]
> This documentation is intended to be implementation-agnostic and authoritative, focusing on the architectural pattern rather than specific software vendor configurations.

## Scope
Clarify what is in scope and out of scope for this topic.

> [!IMPORTANT]
> **In scope:**
> * The hybrid architecture of database-integrated filesystem storage.
> * Transactional consistency between metadata and binary payloads.
> * Streaming I/O patterns for large data sets.
> * Security and backup synchronization concepts.

> [!WARNING]
> **Out of scope:**
> * Specific vendor implementations (e.g., SQL Server FILESTREAM, Oracle SecureFiles).
> * Cloud-native object storage (S3/Blob Storage) unless used as a backing layer for a filestream interface.
> * Standard filesystem-only storage without database integration.

## Definitions
Provide precise definitions for key terms.

| Term | Definition |
|------|------------|
| BLOB | Binary Large Object; a collection of binary data stored as a single entity. |
| Metadata | Structured data stored within the database that describes or points to the Filestream data. |
| Pointer/Handle | A reference stored in a database row that resolves to a specific physical file path. |
| Transactional Consistency | The guarantee that changes to the database record and the associated file occur as a single atomic operation. |
| Streaming I/O | A method of reading or writing data sequentially without loading the entire object into memory. |
| Garbage Collection | The process of removing physical files from the storage layer once their corresponding database references are deleted. |

## Core Concepts
The fundamental idea behind Filestream Storage is the **Dual-Store Approach**. In this model, the database manages the "what" (metadata, relationships, and identity) while the filesystem manages the "how" (efficient byte-level storage and retrieval).

### Transactional Integration
Unlike a standard filesystem, Filestream Storage is bound by the database's transaction log. If a transaction involving a file update is rolled back, the file state must revert to its previous version. This is typically achieved through a combination of write-ahead logging and filesystem shadowing.

### Performance Optimization
Filestream Storage leverages the system cache and specialized I/O paths. By bypassing the database's internal buffer pool for large objects, the system prevents "buffer bloating," where large binary data pushes frequently accessed relational data out of memory.

> [!TIP]
> Think of Filestream Storage like a library's card catalog. The database is the catalog (metadata), providing the location and rules, while the Filestream is the restricted-access archive (the books). You cannot take a book without updating the catalog, and the catalog is useless if the book is missing.

## Standard Model
The standard model for Filestream Storage involves three distinct layers:

1.  **The Relational Layer:** A table containing standard data types (IDs, timestamps, names) and a special column type that acts as a link to the filestream.
2.  **The Intermediary Layer (The Controller):** A driver or kernel-level component that intercepts filesystem requests and validates them against the database's security and transaction state.
3.  **The Physical Layer:** A designated volume on the filesystem where the binary data resides in a structured directory hierarchy, often obfuscated to prevent manual tampering.

In this model, when an application requests a file, the database returns a **Pathname** and a **Transaction Context**. The application then uses a standard API to stream the data directly from the filesystem using that context.

## Common Patterns
*   **Document Management:** Storing PDFs, Word documents, and images where the search criteria (author, date) are relational, but the content is binary.
*   **Medical Imaging:** Storing high-resolution DICOM files where patient records must remain strictly synchronized with the image data.
*   **Media Streaming:** Serving video or audio content where low-latency sequential read access is required.
*   **Archival Systems:** Moving older, large data out of the primary database pages to reduce database size while keeping it queryable.

## Anti-Patterns
*   **Small Object Storage:** Using Filestream for objects smaller than 256 KB. The overhead of opening a file handle often exceeds the cost of storing the data directly in the database page.
*   **Direct Filesystem Manipulation:** Manually renaming, moving, or deleting files in the Filestream directory. This breaks the "Source of Truth" and leads to orphaned records or "missing file" errors.
*   **Frequent Random Access Updates:** Filestream is optimized for streaming. Frequent small, random writes to the middle of a large binary file can lead to fragmentation and performance degradation.

> [!CAUTION]
> Avoid treating the Filestream directory as a standard shared folder. Bypassing the database engine to modify files will result in metadata corruption and loss of transactional integrity.

## Edge Cases
*   **Zero-Byte Files:** Handling the distinction between a NULL reference (no file exists) and a reference to an empty file.
*   **Backup Desynchronization:** If the database backup and the filesystem backup are taken at different times, the restored state may contain "orphan" files (files with no DB record) or "ghost" records (DB records with no file).
*   **In-Place Updates vs. Copy-on-Write:** Some systems handle updates by creating a new file and deleting the old one, which can temporarily double the required storage space during a transaction.
*   **Snapshot Isolation:** Maintaining multiple versions of a file to support concurrent readers while a writer is modifying the data.

## Related Topics
*   **BLOB (Binary Large Object) Management:** The broader category of binary data storage.
*   **Database Transaction Logs:** The mechanism that ensures the atomicity of Filestream operations.
*   **Hierarchical Storage Management (HSM):** Moving Filestream data between different tiers of storage (SSD, HDD, Tape).
*   **Access Control Lists (ACLs):** How filesystem permissions are synchronized with database user roles.

## Change Log
| Version | Date | Description |
|---------|------|-------------|
| 1.0 | 2026-02-11 | Initial AI-generated canonical documentation |