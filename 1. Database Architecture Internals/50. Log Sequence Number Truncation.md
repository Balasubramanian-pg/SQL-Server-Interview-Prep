# 50. Log Sequence Number Truncation

Canonical documentation for [50. Log Sequence Number Truncation](1. Database Architecture Internals/50. Log Sequence Number Truncation.md). This document defines concepts, terminology, and standard usage.

## Purpose
Log Sequence Number (LSN) Truncation is a critical maintenance operation in Write-Ahead Logging (WAL) systems. Its primary purpose is to manage the lifecycle of transaction logs by reclaiming storage space occupied by log records that are no longer required for system recovery, data integrity, or synchronization.

In high-throughput systems, transaction logs grow linearly with database activity. Without a truncation mechanism, these logs would eventually exhaust available storage, leading to system outages. Truncation ensures that the "active" portion of the log—the records necessary for a crash recovery or a rollback—remains available while the "inactive" portion is discarded or marked for overwrite.

> [!NOTE]
> This documentation is intended to be implementation-agnostic and authoritative, focusing on the architectural necessity of log management rather than specific database engine commands.

## Scope
This document covers the theoretical underpinnings and operational logic of LSN truncation within the context of persistent, transactional storage systems.

> [!IMPORTANT]
> **In scope:**
> * The relationship between LSNs and physical storage.
> * Criteria for determining the "Truncation Point."
> * The impact of truncation on recovery and durability.
> * Interaction between truncation and secondary processes (backups, replication).

> [!WARNING]
> **Out of scope:**
> * Specific vendor-specific syntax (e.g., T-SQL, PL/pgSQL).
> * Physical file system management or disk partitioning strategies.
> * Log compression algorithms.

## Definitions
| Term | Definition |
|------|------------|
| Log Sequence Number (LSN) | A unique, monotonically increasing identifier assigned to every record in a transaction log. |
| Truncation Point | The specific LSN below which all log records are considered "inactive" and safe to remove. |
| Active Log | The segment of the transaction log starting from the oldest LSN required for recovery up to the most recent LSN. |
| Checkpoint | A synchronization point where all "dirty" data in memory is flushed to persistent storage, often advancing the truncation point. |
| Log Tail | The most recent end of the log where new LSNs are appended. |
| Log Head | The oldest part of the active log. |

## Core Concepts
The fundamental principle of LSN Truncation is the transition of log records from a "required" state to a "disposable" state. 

In a Write-Ahead Logging system, changes are written to the log before they are applied to the actual data files. If the system crashes, the log is used to "redo" committed transactions and "undo" uncommitted ones. Once a transaction's changes are safely hardened into the main data storage and are no longer needed for replication or backup, the associated LSNs become candidates for truncation.

> [!TIP]
> Think of the transaction log as a scroll that is constantly being unrolled. Truncation is the act of cutting off the beginning of the scroll that has already been read, archived, and acted upon, so the paper can be recycled.

## Standard Model
The standard model for LSN Truncation follows a "Low-Water Mark" logic. The system identifies the minimum LSN required by any of the following three "consumers":

1.  **Recovery Manager:** Needs the LSN of the oldest uncommitted transaction to ensure atomicity.
2.  **Storage Engine:** Needs the LSN of the last successful checkpoint to ensure all prior data is on disk.
3.  **Downstream Consumers:** Needs LSNs that have not yet been shipped to replicas or captured by backup processes.

The **Truncation Point** is defined as the minimum LSN among these consumers. Any log record with an LSN lower than this point is eligible for truncation. In a circular log buffer, this space is marked as reusable; in a segmented log system, the physical files containing these LSNs are deleted or archived.

## Common Patterns
*   **Checkpoint-Based Truncation:** The system automatically triggers truncation after a successful checkpoint, provided no other processes (like replication) require the older logs.
*   **Backup-Linked Truncation:** In systems utilizing "Full Recovery" models, logs are only truncated after a transaction log backup has been successfully completed, ensuring a point-in-time recovery chain.
*   **Continuous Truncation:** A background process monitors the gap between the Log Tail and the Truncation Point, incrementally reclaiming space to prevent spikes in disk usage.

## Anti-Patterns
*   **Manual Log Deletion:** Deleting log files at the OS level without informing the database engine. This breaks the LSN chain and usually results in database corruption or metadata mismatch.
*   **Ignoring Long-Running Transactions:** Allowing a single transaction to remain open for days. This prevents the Truncation Point from advancing, causing the log to grow indefinitely regardless of how many checkpoints occur.
*   **Over-Provisioning as a Substitute for Truncation:** Increasing disk space to delay addressing truncation failures, which eventually leads to unmanageable recovery times during a crash.

> [!CAUTION]
> Avoid circular dependencies where the truncation process requires log space to record its own progress, potentially leading to a "Log Full" deadlock.

## Edge Cases
*   **Orphaned Replication Slots:** If a replica disconnects and the primary system is configured to wait for it, the Truncation Point will freeze. The log will grow until the replication slot is manually dropped or the replica reconnects.
*   **Log Wrap-Around:** In systems using a fixed-size circular log, if the Log Tail catches up to the Log Head before truncation occurs, the system must halt all write operations to prevent overwriting active LSNs.
*   **Partial Truncation:** In segmented log architectures, a segment can only be truncated if *all* LSNs within that segment are below the Truncation Point. A single active LSN at the end of a large segment can prevent the entire file from being reclaimed.

## Related Topics
*   **Write-Ahead Logging (WAL):** The underlying architecture that necessitates LSNs.
*   **Point-in-Time Recovery (PITR):** The process of using truncated log backups to restore a system to a specific moment.
*   **Idempotency in Recovery:** How the system handles re-processing LSNs during a crash recovery.
*   **Checkpointing Algorithms:** The various methods used to flush data and advance the LSN low-water mark.

## Change Log
| Version | Date | Description |
|---------|------|-------------|
| 1.0 | 2026-02-11 | Initial AI-generated canonical documentation |