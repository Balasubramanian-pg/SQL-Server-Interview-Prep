# 33. Service Broker with AGs

Canonical documentation for 33. Service Broker with AGs. This document defines the conceptual model, terminology, and standard usage patterns.

> [!NOTE]
> This documentation is implementation-agnostic and intended to serve as a stable reference.

## 1. Purpose and Problem Space
Describe why 33. Service Broker with AGs exists and the class of problems it addresses.
The Service Broker with Availability Groups (AGs) is designed to provide a highly available and scalable messaging platform for database applications. It addresses the need for reliable, asynchronous communication between services, ensuring that messages are delivered and processed in a fault-tolerant manner, even in the event of database failures or outages. The primary problem space includes ensuring high availability, scalability, and reliability of messaging services in distributed database environments.

## 2. Conceptual Overview
Provide a high-level mental model of the topic.
The Service Broker with AGs integrates the Service Broker messaging platform with SQL Server Availability Groups, allowing for the creation of highly available messaging environments. This integration enables messages to be sent and received across multiple databases, with automatic failover and redundancy, ensuring that messaging services remain operational even in the event of database failures.

## 3. Terminology and Definitions
| Term | Definition |
|------|------------|
| Service Broker | A messaging platform that enables asynchronous communication between services |
| Availability Group (AG) | A high-availability solution that provides automatic failover and redundancy for databases |
| Message | A unit of data exchanged between services through the Service Broker |
| Conversation | A dialogue between two or more services, consisting of a series of messages |
| Endpoint | A connection point for services to send and receive messages |

## 4. Core Concepts
Explain the fundamental ideas that form the basis of this topic.
The core concepts of Service Broker with AGs include:
* **Decoupling**: Services are decoupled from each other, allowing for greater flexibility and scalability.
* **Asynchronous communication**: Messages are sent and received asynchronously, enabling non-blocking communication between services.
* **Message queuing**: Messages are stored in queues, ensuring that they are not lost in the event of service failures.
* **Automatic failover**: AGs provide automatic failover, ensuring that messaging services remain operational even in the event of database failures.

## 5. Standard Model
Describe the generally accepted or recommended model.
The standard model for Service Broker with AGs involves:
* Creating an Availability Group for the databases that will participate in the messaging platform.
* Configuring the Service Broker to use the Availability Group as the underlying storage mechanism.
* Creating endpoints for services to send and receive messages.
* Implementing message handling and processing logic in each service.

## 6. Common Patterns
Document recurring, accepted patterns.
Common patterns for Service Broker with AGs include:
* **Request-response pattern**: A service sends a request message and receives a response message.
* **Publish-subscribe pattern**: A service publishes messages to a topic, and other services subscribe to receive those messages.
* **Message queuing pattern**: Messages are stored in queues and processed by services as needed.

## 7. Anti-Patterns
Describe common but discouraged practices.
Anti-patterns for Service Broker with AGs include:
* **Tight coupling**: Services are tightly coupled, making it difficult to modify or replace individual services.
* **Synchronous communication**: Services communicate synchronously, blocking each other and reducing scalability.
* **Inadequate error handling**: Services do not handle errors properly, leading to message loss or corruption.

## 8. References
Provide exactly five authoritative external references.
1. Microsoft Documentation: [Service Broker](https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/sql-server-service-broker?view=sql-server-ver15)
2. Microsoft Documentation: [Availability Groups](https://docs.microsoft.com/en-us/sql/database-engine/availability-groups/windows/always-on-availability-groups-sql-server?view=sql-server-ver15)
3. SQL Server Blog: [Service Broker and Availability Groups](https://sqlserverblog.com/2019/05/20/service-broker-and-availability-groups/)
4. MSDN Forum: [Service Broker with AGs](https://social.msdn.microsoft.com/Forums/sqlserver/en-US/home?forum=sqldatabaseengine)
5. SQL Server Tutorial: [Service Broker Tutorial](https://www.sqlservertutorial.net/sql-server-service-broker/)

## 9. Change Log
| Version | Date | Description |
|---------|------|-------------|
| 1.0 | 2026-02-14 | Initial documentation |