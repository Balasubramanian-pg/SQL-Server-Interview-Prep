# 1. Stored Procedure Recompilation: Causes

Canonical documentation for [1. Stored Procedure Recompilation: Causes](7. Programming Objects/1. Stored Procedure Recompilation: Causes.md). This document defines concepts, terminology, and standard usage.

## Purpose
The purpose of stored procedure recompilation is to ensure that the execution plan used by a database engine remains accurate, valid, and optimized for the current state of the database. Recompilation addresses the "stale plan" problem, where an existing execution plan becomes inefficient or incorrect due to changes in data distribution, schema structure, or the execution environment.

> [!NOTE]
> This documentation is intended to be implementation-agnostic and authoritative, focusing on the underlying logic that governs relational database management systems (RDBMS).

## Scope
This document focuses exclusively on the triggers and underlying reasons why a previously compiled execution plan is discarded and a new one is generated.

> [!IMPORTANT]
> **In scope:**
> * Logical triggers for plan invalidation.
> * Structural and environmental factors influencing recompilation.
> * Theoretical boundaries of the recompilation lifecycle.

> [!WARNING]
> **Out of scope:**
> * Specific vendor implementations (e.g., SQL Server `RECOMPILE` hints, Oracle `DBMS_SHARED_POOL`).
> * Performance tuning of specific queries.
> * Hardware-level memory management of plan caches.

## Definitions
| Term | Definition |
|------|------------|
| Execution Plan | A roadmap generated by the query optimizer detailing the physical operations required to execute a stored procedure. |
| Plan Cache | A memory buffer where the database engine stores execution plans for reuse to avoid the cost of compilation. |
| Schema Stability | The state in which the underlying structure of tables, indexes, and constraints remains unchanged. |
| Statistics | Metadata describing the distribution and density of data within columns and indexes. |
| Invalidation | The process of marking a cached plan as unusable, necessitating a new compilation upon the next execution. |

## Core Concepts
The fundamental concept of recompilation is the balance between **computational overhead** and **execution efficiency**. Compiling a plan requires CPU and memory resources; however, executing an outdated plan can lead to catastrophic performance degradation.

> [!TIP]
> Think of an execution plan like a GPS route. If a new highway is built (Schema Change) or a road is closed (Data Change), the original route is no longer the fastest. Recompilation is the "recalculating" phase that ensures the driver takes the most efficient path based on current conditions.

## Standard Model
The standard model for recompilation causes categorizes triggers into four primary domains:

### 1. Schema-Based Changes (DDL)
Any modification to the objects referenced by a stored procedure will trigger a recompilation. This ensures the plan does not attempt to access non-existent columns or ignore new, more efficient indexes.
*   Adding, dropping, or altering columns in referenced tables.
*   Adding or dropping indexes that could be utilized by the procedure.
*   Modifying constraints (e.g., Check, Foreign Key) that the optimizer uses for simplification.

### 2. Statistics-Based Changes
Database optimizers rely on statistics to estimate row counts and costs. When data changes significantly, the old plan may no longer be optimal.
*   **Threshold-based updates:** Recompilation occurs when a specific percentage of data in a referenced table has been modified (Insert/Update/Delete).
*   **Manual statistics refresh:** Explicitly updating statistics often marks dependent plans as invalid.

### 3. Environment and Session Settings
The execution environment must be consistent between compilation and execution. If a session's settings differ from those used to create the cached plan, the engine may force a recompile to ensure correct results.
*   Changes in regional settings or date formats.
*   Changes in null-handling behavior or arithmetic overflow settings.

### 4. Explicit Invalidation
The system or an administrator can manually force the engine to discard plans.
*   Clearing the plan cache or a specific plan ID.
*   Using procedure-level directives that prevent plan caching.

## Common Patterns
*   **Automatic Recompilation:** The engine detects a change in statistics or schema and transparently regenerates the plan before execution.
*   **Statement-Level Recompilation:** Modern engines may recompile only the specific statement within a procedure that is affected by a change, rather than the entire module.
*   **Deferred Recompilation:** The plan is marked invalid but is not recompiled until the next time the procedure is actually called.

## Anti-Patterns
*   **Interleaving DDL and DML:** Mixing Data Definition Language (e.g., `CREATE TABLE #Temp`) with Data Manipulation Language (e.g., `SELECT`) inside a procedure can cause multiple recompilations during a single execution.
*   **Volatile Temporary Object Usage:** Excessive creation and destruction of temporary objects within a loop, forcing the optimizer to re-evaluate the plan constantly.
*   **Frequent Statistics Updates:** Setting statistics to update too aggressively can lead to "recompile storms," where CPU is exhausted by constant plan generation.

> [!CAUTION]
> Avoid circular dependencies where a stored procedure modifies the schema of a table it subsequently queries, as this guarantees a recompile on every execution and can lead to severe resource contention.

## Edge Cases
*   **Plan Aging/Eviction:** While not a "cause" of recompilation in the sense of invalidation, plans may be evicted from the cache due to memory pressure. The subsequent execution requires a "recompile," though the underlying logic hasn't changed.
*   **Parameter Sniffing:** In some scenarios, a plan is recompiled because the engine determines the current parameters are so different from the cached plan's parameters that the existing plan would be functionally unusable.
*   **Object Renaming:** Renaming a table referenced by a procedure usually breaks the link, but in some systems, it triggers a recompile that fails until the procedure code is updated.

## Related Topics
*   **Execution Plan Optimization:** The process of choosing the best path.
*   **Plan Cache Management:** How the engine stores and purges plans.
*   **Parameterization:** How variables affect plan reuse vs. recompilation.

## Change Log
| Version | Date | Description |
|---------|------|-------------|
| 1.0 | 2026-02-14 | Initial AI-generated canonical documentation |