# 1. Execution Plan: Estimated vs Actual

Canonical documentation for [1. Execution Plan: Estimated vs Actual](3. Performance Tuning Optimization/1. Execution Plan: Estimated vs Actual.md). This document defines concepts, terminology, and standard usage.

## Purpose
The purpose of an execution plan is to provide a structured representation of the operations a system intends to perform to satisfy a request, typically a data retrieval or processing task. The distinction between "Estimated" and "Actual" plans exists to bridge the gap between theoretical optimization and runtime reality. 

By comparing these two states, systems and operators can identify inefficiencies, such as inaccurate metadata, resource bottlenecks, or flawed logic, ensuring that the computational path taken is as close to the optimal path as possible.

> [!NOTE]
> This documentation is intended to be implementation-agnostic and authoritative, focusing on the universal principles of query and task optimization.

## Scope
This documentation covers the theoretical framework of plan generation, the metrics used for estimation, and the capture of runtime telemetry.

> [!IMPORTANT]
> **In scope:**
> * The lifecycle of a plan from compilation to execution.
> * Discrepancy analysis between predicted and real-world metrics.
> * The role of statistics and metadata in plan generation.

> [!WARNING]
> **Out of scope:**
> * Specific vendor implementations (e.g., SQL Server Showplan, Oracle Explain Plan, PostgreSQL EXPLAIN ANALYZE).
> * Specific syntax for triggering plan generation.

## Definitions
| Term | Definition |
|------|------------|
| Execution Plan | A tree or graph of operations representing the logic required to execute a command. |
| Estimated Plan | A plan generated by an optimizer before execution, based on available metadata and statistical models. |
| Actual Plan | A plan produced during or after execution that includes real-time metrics such as elapsed time and resource consumption. |
| Cardinality | The estimated or actual number of elements (rows, objects, packets) processed at a specific step. |
| Cost | A relative, unitless value assigned by an optimizer to represent the computational effort of an operation. |
| Statistics | Metadata describing the distribution and characteristics of data used to inform the optimizer. |

## Core Concepts
The fundamental concept underlying execution plans is the **Optimization Boundary**. Before a task is executed, the system must decide *how* to execute it. 

The **Estimated Plan** is a prediction. It relies on the "Cost-Based Optimizer" model, where the system evaluates multiple potential paths and selects the one with the lowest calculated cost. This calculation is only as good as the underlying statistics.

The **Actual Plan** is the ground truth. It contains the same logical steps as the estimated plan but appends runtime telemetry. The primary value of the actual plan is not the plan itself, but the delta between its metrics and the estimated metrics.

> [!TIP]
> Think of the Estimated Plan as a GPS route calculated before you start driving, based on speed limits and historical data. The Actual Plan is the dashcam footage and GPS log of the trip, showing where you actually encountered traffic or road closures.

## Standard Model
The standard model for execution plan analysis follows a linear progression:

1.  **Parsing/Translation:** The request is converted into a logical tree.
2.  **Optimization (Estimation):** The system applies transformation rules and statistical models to produce an **Estimated Plan**. This plan is stored in a cache for reuse.
3.  **Execution:** The system follows the plan's instructions.
4.  **Instrumentation (Actualization):** During execution, the system counts the items processed, measures time per node, and tracks memory/CPU usage.
5.  **Post-Execution Analysis:** The **Actual Plan** is rendered, allowing for a side-by-side comparison with the estimate.

## Common Patterns
*   **Cardinality Misalignment:** The most common pattern for performance degradation. If the estimate predicts 1 item but the actual execution processes 1,000,000, the chosen algorithm (e.g., a nested loop) may be catastrophically inefficient.
*   **Plan Reuse:** Systems often reuse an estimated plan for different inputs. If the data distribution is non-uniform, a plan optimized for one input may perform poorly for another.
*   **Operator Analysis:** Identifying which specific node in the plan graph accounts for the highest percentage of the "Actual" cost versus the "Estimated" cost.

## Anti-Patterns
*   **Estimates-Only Tuning:** Attempting to optimize a complex system based solely on estimated plans without verifying runtime behavior.
*   **Stale Metadata Reliance:** Allowing the statistics that inform the estimated plan to become outdated, leading the optimizer to make decisions based on "ghost" data.
*   **Over-Instrumentation:** Capturing actual plans for every single trivial operation, which can introduce significant overhead and skew the very performance metrics being measured.

> [!CAUTION]
> Avoid assuming that an "Actual Plan" is a different logical path than the "Estimated Plan." In most systems, the actual plan is simply the estimated plan populated with real numbers. If the logic differs, you are likely dealing with dynamic re-optimization.

## Edge Cases
*   **Zero-Row Estimates:** When an optimizer predicts zero rows, it may choose highly aggressive optimizations that fail or stall if even a single row is encountered at runtime.
*   **Deferred Compilation:** Some systems do not generate a full estimated plan until the first few chunks of data are processed, blurring the line between estimated and actual.
*   **Hardware Interrupts:** An actual plan may show high latency that has nothing to do with the plan logic, but rather external factors like disk failure or network throttling, which the estimated plan cannot predict.

## Related Topics
*   **Cost-Based Optimization (CBO):** The mathematical framework for generating estimates.
*   **Statistics and Histograms:** The data structures that provide the "knowledge" for estimations.
*   **Index Selection:** The process of choosing data access paths within a plan.
*   **Parallelism:** How plans are split across multiple execution threads.

## Change Log
| Version | Date | Description |
|---------|------|-------------|
| 1.0 | 2025-02-11 | Initial AI-generated canonical documentation |