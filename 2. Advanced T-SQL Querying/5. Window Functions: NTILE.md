# 5. Window Functions: NTILE

### 1. The Anchor
* **One-Sentence Pitch:** NTILE is a window function that distributes rows within an ordered partition into a specified number of approximately equal groups, or "buckets," to facilitate statistical binning and percentile analysis.
* **Category:** Technical Skill / SQL Data Analysis

### 2. The Mechanics
* **Key Detail A: Distribution and Remainder Logic:** NTILE(n) calculates the number of rows per bucket by dividing the total row count by the integer *n*. If the total count is not perfectly divisible by *n*, the function distributes the remaining rows one-by-one into the starting buckets (e.g., in a set of 10 rows with NTILE(4), buckets 1 and 2 will have 3 rows, while buckets 3 and 4 will have 2 rows).
* **Key Detail B: Deterministic Ordering Requirement:** The function requires an `ORDER BY` clause within the `OVER()` partition. Because NTILE assigns bucket numbers based on the physical sequence of rows, the stability of the output depends entirely on the uniqueness of the sort key; without a unique sort key, rows with identical values might be assigned to different buckets.
* **The Logic:** NTILE solves the problem of relative ranking where specific values are less important than the "tier" a record belongs to. It is used to normalize data distributions, allowing analysts to identify the top or bottom "X percent" of a dataset regardless of the absolute values or gaps between data points.

> [!IMPORTANT]
> NTILE does not respect "ties" in the same way that `RANK()` or `DENSE_RANK()` does. If two rows have the same value but the bucket limit is reached, one row will be placed in the current bucket and the other in the next, based on the internal processing order.

### 3. The Evidence
* **Context (CAR/STAR):** A financial services client needed to categorize their loan portfolio into four risk quartiles based on credit scores, but the scores were non-uniformly distributed with significant clustering at certain values.
* **Action:** I utilized `NTILE(4) OVER (ORDER BY credit_score DESC)` to segment the entire portfolio into four equal-sized groups. I combined this with a `PARTITION BY loan_type` to ensure that personal loans and mortgages were binned independently against their respective peers.
* **Result:** This approach provided a perfectly balanced distribution for the risk assessment team, enabling them to apply different auditing intensities to each quartile. This replaced a manual Excel-based binning process, reducing the reporting cycle from three days to five minutes.

> [!TIP]
> When using NTILE for deciles (NTILE(10)) or quartiles (NTILE(4)), always check if your total row count is significantly smaller than your bucket count, as this will result in empty or single-row buckets, potentially skewing your analysis.

### 4. The Interview "Pivot"
* **Triggers:** "How do you handle data segmentation in SQL?", "How would you find the top 25% of performers?", or "What is the difference between NTILE and RANK?"
* **The Connection:** This topic proves I can translate high-level business requirements—like "customer segmentation" or "performance tiering"—into robust, scalable SQL code. It demonstrates an understanding of both data distribution mechanics and the practical limitations of window functions when dealing with non-unique datasets.

> [!WARNING]
> If an interviewer asks about "Percentiles," clarify if they want `NTILE` (which forces equal group sizes) or `PERCENT_RANK` (which calculates the relative rank as a percentage). NTILE is for grouping; PERCENT_RANK is for calculating a specific row's standing.